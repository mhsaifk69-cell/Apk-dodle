<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apk Dodle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --bg-color: #ffffff; --text-color: #333333; --card-bg: #f8f9fa; }
        [data-theme="dark"] { --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; }
        .card { background-color: var(--card-bg); color: var(--text-color); border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .app-icon { width: 80px; height: 80px; border-radius: 15px; object-fit: cover; }
        .screenshot-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; }
        .screenshot-img { height: 250px; border-radius: 10px; cursor: pointer; transition: transform 0.2s; }
        .screenshot-img:hover { opacity: 0.9; }
        .navbar { background-color: #ff9800; }
        
        /* New Features Style */
        .cat-btn { border-radius: 20px; border: 1px solid #ff9800; color: #ff9800; background: transparent; transition: 0.3s; margin-right: 5px; }
        .cat-btn.active, .cat-btn:hover { background: #ff9800; color: white; }
        .trending-badge { position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

        /* --- Full Screen Image Viewer Styles (Added) --- */
        #imgViewer {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            overflow: auto;
            align-items: center;
            justify-content: center;
        }
        .close-view {
            position: fixed;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100000;
        }
        #fullResImage {
            margin: auto;
            display: block;
            max-width: 100%;
            max-height: 100vh;
            object-fit: contain;
            transition: transform 0.25s ease;
            cursor: zoom-in;
        }
        #fullResImage.zoomed {
            transform: scale(2.5);
            cursor: zoom-out;
            max-width: none;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" onclick="showHome()">APK Dodle</a>
            <div class="d-flex align-items-center gap-2 ms-auto">
                <button class="btn btn-outline-light btn-sm" id="themeToggle"><i class="fas fa-moon"></i></button>
                <div id="authSection">
                    <button class="btn btn-light btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#authModal">Login</button>
                </div>
                <div id="userProfile" style="display:none;">
                    <i class="fas fa-user-circle text-white fa-lg"></i>
                    <button class="btn btn-danger btn-sm ms-2" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4" id="mainContainer">
        
        <!-- Search -->
        <input type="text" id="searchInput" class="form-control form-control-lg mb-3" placeholder="Search for find APKS...">

        <!-- Categories -->
        <div class="d-flex overflow-auto pb-2 mb-3">
            <button class="cat-btn px-3 py-1 active" onclick="filterCat('All', this)">All</button>
            <button class="cat-btn px-3 py-1" onclick="filterCat('Game', this)">Games</button>
            <button class="cat-btn px-3 py-1" onclick="filterCat('Social', this)">Social</button>
            <button class="cat-btn px-3 py-1" onclick="filterCat('Tool', this)">Tools</button>
            <button class="cat-btn px-3 py-1" onclick="filterCat('Productivity', this)">Productivity</button>
        </div>

        <!-- Trending Section -->
        <div id="trendingSection" class="mb-4">
            <h5 class="fw-bold text-danger"><i class="fas fa-fire"></i> Trending Now</h5>
            <div class="d-flex gap-3 overflow-auto pb-3" id="trendingList"></div>
        </div>

        <!-- App List -->
        <h5 class="border-bottom pb-2">All Apps</h5>
        <div id="appList" class="row g-3">
            <div class="text-center"><div class="spinner-border text-warning"></div></div>
        </div>
    </div>

    <!-- Detail View -->
    <div class="container mt-4" id="appDetailView" style="display: none;">
        <button class="btn btn-secondary mb-3" onclick="showHome()"><i class="fas fa-arrow-left"></i> Back</button>
        
        <div class="row">
            <!-- Left: App Details + Reviews -->
            <div class="col-lg-8">
                <div class="card p-4 mb-4">
                    <div class="d-flex align-items-center mb-4">
                        <img id="detailIcon" src="" class="app-icon me-3">
                        <div>
                            <h2 id="detailName" class="fw-bold mb-0">App Name</h2>
                            <span class="badge bg-warning text-dark" id="detailCat">Category</span>
                            <p class="text-muted mb-0">Version: <span id="detailVersion"></span></p>
                            <small class="text-muted"><i class="fas fa-download"></i> <span id="detailDL">0</span> Downloads</small>
                        </div>
                    </div>
                    <a id="detailDownloadBtn" href="#" target="_blank" class="btn btn-success btn-lg w-100 mb-4"><i class="fas fa-download"></i> Download APK</a>
                    
                    <h5>Description</h5>
                    <p id="detailDesc">...</p>
                    
                    <h5>Screenshots (Click to Zoom)</h5>
                    <div class="screenshot-container" id="detailScreenshots"></div>
                </div>

                <!-- Review System -->
                <div class="card p-3">
                    <h5>User Reviews <i class="fas fa-star text-warning"></i></h5>
                    <div id="reviewBox" style="display:none;" class="mb-3">
                        <div class="input-group">
                            <select class="form-select" id="reviewRating" style="max-width:80px">
                                <option value="5">5‚òÖ</option><option value="4">4‚òÖ</option><option value="3">3‚òÖ</option><option value="2">2‚òÖ</option><option value="1">1‚òÖ</option>
                            </select>
                            <input type="text" id="reviewText" class="form-control" placeholder="Write a review...">
                            <button class="btn btn-primary" onclick="postReview()">Post</button>
                        </div>
                    </div>
                    <div id="loginAlert" class="alert alert-secondary small p-2">Login to post reviews.</div>
                    <div id="reviewsList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Right: Version History -->
            <div class="col-lg-4">
                <div class="card p-3">
                    <h5 class="fw-bold mb-3">Old Versions üöÄ</h5>
                    <div id="versionList" class="list-group list-group-flush small"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4 bg-dark text-white text-center">
        <div class="container">
            <p>Developed by: saif‚ò†Ô∏è | saif industries</p>
            <p><i class="fas fa-envelope"></i> mhsaifk69@gmail.com</p>
        </div>
    </footer>

    <!-- Full Screen Image Viewer Modal (Added) -->
    <div id="imgViewer" style="display: none;">
        <span class="close-view" onclick="closeImageView()">&times;</span>
        <img class="modal-content" id="fullResImage" onclick="toggleZoom(this)">
    </div>

    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-dark">Login / Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-dark">
                    <input type="email" id="authEmail" class="form-control mb-2" placeholder="Email">
                    <input type="password" id="authPass" class="form-control mb-2" placeholder="Password">
                    <button class="btn btn-primary w-100 mb-2" onclick="handleAuth('login')">Login</button>
                    <button class="btn btn-outline-secondary w-100" onclick="handleAuth('signup')">Sign Up</button>
                    <p id="authError" class="text-danger mt-2 small"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

   <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB_utJ37MVmf8T-tjqXicVHiHAYtBD8CPQ",
            authDomain: "my-website-b1abf.firebaseapp.com",
            projectId: "my-website-b1abf",
            storageBucket: "my-website-b1abf.firebasestorage.app",
            messagingSenderId: "1047101394274",
            appId: "1:1047101394274:web:66a7a0719f8f299e37703b",
            measurementId: "G-W83Q2CXC8V"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Vars
        let allApps = [];
        let currentUser = null;
        let currentAppId = null;

        // Theme
        const themeBtn = document.getElementById('themeToggle');
        let isDark = localStorage.getItem('theme') === 'dark';
        function applyTheme() {
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        themeBtn.addEventListener('click', () => { isDark = !isDark; applyTheme(); });
        applyTheme();

        // Auth
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('reviewBox').style.display = 'block';
                document.getElementById('loginAlert').style.display = 'none';
                db.collection('users').doc(user.uid).set({ email: user.email }, { merge: true });
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('reviewBox').style.display = 'none';
                document.getElementById('loginAlert').style.display = 'block';
            }
        });

        function handleAuth(type) {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const p = type === 'login' ? auth.signInWithEmailAndPassword(email, pass) : auth.createUserWithEmailAndPassword(email, pass);
            p.then(() => bootstrap.Modal.getInstance(document.getElementById('authModal')).hide())
             .catch(e => document.getElementById('authError').innerText = e.message);
        }
        function logout() { auth.signOut(); }

        // Load Data
        db.collection('apks').orderBy('date', 'desc').onSnapshot(snapshot => {
            allApps = [];
            snapshot.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                allApps.push(data);
            });
            renderApps(allApps);
            renderTrending();
        });

        function renderApps(apps) {
            const list = document.getElementById('appList');
            list.innerHTML = apps.length ? '' : '<p class="text-center">No apps found.</p>';
            apps.forEach(app => {
                list.innerHTML += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card p-3 h-100 d-flex flex-row align-items-center" onclick="openApp('${app.id}')" style="cursor:pointer">
                            <img src="${app.iconUrl}" class="app-icon me-3">
                            <div>
                                <h5 class="mb-0 text-truncate" style="max-width:150px">${app.name}</h5>
                                <span class="badge bg-secondary" style="font-size:0.7rem">${app.category || 'App'}</span>
                                <small class="text-muted d-block">${app.version}</small>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function renderTrending() {
            const sorted = [...allApps].sort((a,b) => (b.downloads||0) - (a.downloads||0)).slice(0,6);
            const box = document.getElementById('trendingList');
            box.innerHTML = '';
            sorted.forEach(app => {
                box.innerHTML += `
                    <div class="card p-2 d-flex flex-column align-items-center" style="min-width: 110px; cursor:pointer;" onclick="openApp('${app.id}')">
                        <div class="trending-badge"><i class="fas fa-fire"></i></div>
                        <img src="${app.iconUrl}" class="app-icon mb-2" style="width:50px; height:50px;">
                        <small class="fw-bold text-truncate" style="max-width:90px">${app.name}</small>
                        <small class="text-muted" style="font-size:0.7rem">${app.downloads||0} downloaded </small>
                    </div>`;
            });
        }

        // Search Logic (Fixed & Verified)
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if(term === "") {
                renderApps(allApps); // ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
            } else {
                const filtered = allApps.filter(a => a.name.toLowerCase().includes(term));
                renderApps(filtered);
            }
        });

        function filterCat(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderApps(cat === 'All' ? allApps : allApps.filter(a => a.category === cat));
        }

        // --- NAVIGATION & HISTORY LOGIC (NEW) ---
        
        // 1. Browser Back Button Handler
        window.onpopstate = function(event) {
            if (event.state && event.state.page === 'detail') {
                // If history says detail, show detail (rare case)
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('appDetailView').style.display = 'block';
            } else {
                // Default: Go back to Home
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('appDetailView').style.display = 'none';
                
                // Close Image Viewer if open
                document.getElementById('imgViewer').style.display = "none";
                document.body.style.overflow = "auto";
            }
        };

        // Open App Logic (Updated with History Push)
        function openApp(id) {
            currentAppId = id;
            const app = allApps.find(a => a.id === id);
            if (!app) return;

            // Push History State (This fixes the back button issue)
            window.history.pushState({page: 'detail', id: id}, null, `#app/${id}`);

            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('appDetailView').style.display = 'block';
            window.scrollTo(0,0);

            // Populate Data
            document.getElementById('detailName').innerText = app.name;
            document.getElementById('detailVersion').innerText = app.version;
            document.getElementById('detailCat').innerText = app.category || 'App';
            document.getElementById('detailDL').innerText = app.downloads || 0;
            document.getElementById('detailDesc').innerText = app.description || "No desc.";
            document.getElementById('detailIcon').src = app.iconUrl;

            const dlBtn = document.getElementById('detailDownloadBtn');
            dlBtn.href = app.downloadLink;
            dlBtn.onclick = () => {
                db.collection('apks').doc(id).update({ downloads: firebase.firestore.FieldValue.increment(1) });
                db.collection('stats').doc('global').update({ totalDownloads: firebase.firestore.FieldValue.increment(1) });
            };

            const ssBox = document.getElementById('detailScreenshots');
            ssBox.innerHTML = (app.screenshots||[]).map(url => 
                `<img src="${url}" class="screenshot-img" onclick="viewImage('${url}')" style="cursor:pointer" title="Click to Zoom">`
            ).join('') || '<p class="text-muted">No screenshots available.</p>';

            const vList = document.getElementById('versionList');
            const versions = allApps.filter(a => a.name === app.name && a.id !== id);
            vList.innerHTML = versions.length ? '' : '<p class="text-muted">No old versions found.</p>';
            versions.forEach(v => {
                vList.innerHTML += `
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between" onclick="openApp('${v.id}')">
                        <div><span class="fw-bold">${v.version}</span></div>
                        <i class="fas fa-download text-muted"></i>
                    </a>`;
            });

            loadReviews(id);
        }

        // Show Home Logic (Updated to use History Back)
        function showHome() {
            // Manually going back triggers the onpopstate function above
            window.history.back();
        }

        // Reviews
        function postReview() {
            if(!currentUser) return;
            const text = document.getElementById('reviewText').value;
            if(!text) return;
            db.collection('comments').add({
                apkId: currentAppId,
                user: currentUser.email.split('@')[0],
                text: text,
                rating: document.getElementById('reviewRating').value,
                date: new Date().toISOString()
            }).then(() => {
                document.getElementById('reviewText').value = '';
                loadReviews(currentAppId);
            });
        }

        function loadReviews(id) {
            const list = document.getElementById('reviewsList');
            list.innerHTML = 'Loading...';
            db.collection('comments').where('apkId', '==', id).get().then(snap => {
                list.innerHTML = snap.empty ? '<p class="text-muted small">No reviews yet.</p>' : '';
                snap.forEach(doc => {
                    const r = doc.data();
                    list.innerHTML += `
                        <div class="border-bottom py-2">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${r.user}</span>
                                <span class="text-warning small">${'‚òÖ'.repeat(r.rating)}</span>
                            </div>
                            <p class="mb-0 small text-muted">${r.text}</p>
                        </div>`;
                });
            });
        }

        // Image Viewer
        function viewImage(url) {
            const viewer = document.getElementById('imgViewer');
            const img = document.getElementById('fullResImage');
            
            // Push a history state for the image viewer too! (Pro Feature)
            window.history.pushState({page: 'image'}, null, '#view-image');
            
            img.src = url;
            viewer.style.display = "flex";
            img.classList.remove('zoomed');
            document.body.style.overflow = "hidden";
        }

        function closeImageView() {
            // Going back will trigger close via onpopstate if using back button
            // Or if clicked manually, we force back
            window.history.back();
        }

        function toggleZoom(element) {
            element.classList.toggle('zoomed');
            const viewer = document.getElementById('imgViewer');
            if (element.classList.contains('zoomed')) {
                viewer.style.display = "block";
                viewer.style.overflow = "auto";
            } else {
                viewer.style.display = "flex";
                viewer.style.overflow = "hidden";
            }
        }
    </script>
</body>
</html>